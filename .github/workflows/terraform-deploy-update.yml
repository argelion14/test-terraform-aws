
on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      tf-plan-extra-args:
        required: false
        type: string
      cloud:
        required: true
        type: string

jobs:
  terraform-plan:
    name: TERRAFORM PLAN
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean Terraform State
        run: rm -rf .terraform

      - name: Validate terraform extra args
        if: ${{ inputs.tf-plan-extra-args }}
        run: | 
          echo "Validating terraform extra args: ${{ inputs.tf-plan-extra-args }}"

      - name: Load Configuration from properties.env
        id: load-config
        run: |
          sed -i 's/\r$//' properties.env
          if [ -f "properties.env" ]; then
            echo "Loading configuration from properties.env"
            # Source the file to load variables
            source properties.env

            # Set default if not specified
            if [ -z "$TERRAFORM_STRUCTURE_MODE" != "root" ] && [ "$TERRAFORM_STRUCTURE_MODE" != "environment" ]; then
              echo "x Invalid TERRAFORM STRUCTURE_MODE: $TERRAFORM_STRUCTURE_MODE. Must be 'root' or 'environment'."
              exit 10
            fi

            if [ "$REPLACE_TOKENS" = "true" ]; then
              echo "Repalce tokens is enabled"
              echo "replace-tokens=true" >> $GITHUB_OUTPUT
            fi

            echo "Terraform structure mode: $TERRAFORM_STRUCTURE_MODE"
            echo "TERRAFORM_STRUCTURE_MODE=$TERRAFORM_STRUCTURE_MODE" >> $GITHUB_ENV
          else
            echo "properties.env not found, using defaults mode: root"
            echo "TERRAFORM_STRUCTURE_MODE=root" >> $GITHUB_ENV
          fi

      - name: Set Terraform directory structure -> ${{ env.TERRAFORM_STRUCTURE_MODE }}
        run: |
          if [ "${{ env.TERRAFORM_STRUCTURE_MODE }}" = "environment" ]; then
            echo "Using environment Terraform structure"
            echo "TERRAFORM_DIR=./${{ inputs.environment }}" >> $GITHUB_ENV
            echo "TFVARS_PATH=./terraform.tfvars" >> $GITHUB_ENV
            echo "STATE_CONFIG_PATH=./state-config" >> $GITHUB_ENV
          else
            echo "Using root Terraform structure"
            echo "TERRAFORM_DIR=." >> $GITHUB_ENV
            echo "TFVARS_PATH=./${{ inputs.environment }}/terraform.tfvars" >> $GITHUB_ENV
            echo "STATE_CONFIG_PATH=./${{ inputs.environment }}/state.config" >> $GITHUB_ENV
          fi

      - name: Enable Terraform logging
        if: ${{ vars.TF_LOG }}
        run: |
          TF_LOG=${{ vars.TF_LOG }}
          echo "Enabling Terraform logging with level: $TF_LOG"
          echo "TF_LOG=$TF_LOG" >> $GITHUB_ENV

      # - name: Configure Terraform credentials
      #   run: |
      #     mkdir -p ~/.terraform.d
      #     echo '{
      #       "credentials": {
      #         "app.terraform.io": {
      #           "token": "'${{ secrets.TFE_TOKEN }}'"
      #         }
      #       }
      #     }' > ~/.terraform.d/credentials.tfrc.json

      - name: Debug OIDC Token Information
        if: ${{ vars.TF_LOG }}
        run: |
          echo "=== GitHub OIDC Token Debug Information ==="
          echo "Repository: ${{ github.repository }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo ""
          echo "Expected OIDC Values:"
          echo "Issuer: https://token.actions.githubusercontent.com"
          echo "Audience: ${{ github.repository }}"
          echo "Subject: repo:${{ github.repository }}:environment:${{ inputs.environment }}"
          echo ""
          echo "Token Claims (if available):"
          if [ -n "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ] && [ -n "$ACTIONS_ID_TOKEN_REQUEST_URL" ]; then
            echo "Requesting OIDE token..."
            curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
              -H "Accept: application/json"; api-version=2.0" \
              "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${{ github.repository }}" | \
              jq -r '.value' | 
              jq -R 'split(".") | .[1] | @base64d | fromjson' 2>/dev/null || echo "Unable to decode token claims."
          else
            echo "OIDC token environment variables not set."
          fi

      - name: Debug OIDC token
        run: |
          echo "Solicitando token OIDC..."
          TOKEN=$(curl -sSL -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com")
          echo "Token recibido: ${TOKEN:0:100}..."

      - name: Show Environment Variables
        run: |
          echo "============================================"
          echo "üîç Current Environment Context"
          echo "============================================"
          echo "Environment: ${{ inputs.environment }}"
          echo ""
          echo "AWS_DEPLOYER_ROLE: ${{ vars.AWS_DEPLOYER_ROLE }}"
          echo "AWS_OIDC_ROLE:     ${{ vars.AWS_OIDC_ROLE }}"
          echo "AWS_REGION:        ${{ vars.AWS_REGION }}"
          echo "S3_BUCKET:         ${{ vars.S3_BUCKET }}"
          echo ""
          echo "Working directory: ${{ env.TERRAFORM_DIR }}"
          echo "TFVARS Path:       ${{ env.TFVARS_PATH }}"
          echo "State Config Path: ${{ env.STATE_CONFIG_PATH }}"
          echo "============================================"
      - name: AWS Login with OIDC
        if: ${{ inputs.cloud == 'aws' }}
        id: 'creds'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_OIDC_ROLE }}
          aws-region: ${{ vars.AWS_REGION }}
          output-credentials: true

      - name: AWS Assume Deployer Role
        if: ${{ inputs.cloud == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOYER_ROLE }}
          aws-region: ${{ vars.AWS_REGION }}
          aws-access-key-id: ${{ steps.creds.outputs.access-key-id }}
          aws-secret-access-key: ${{ steps.creds.outputs.secret-access-key }}
          aws-session-token: ${{ steps.creds.outputs.session-token }}
      
      - name: Replace tokens in terraform files
        if: ${{ steps.load-config.outputs.replace-tokens == 'true' }}
        run: |
          echo "HOLA"
      
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Authenticate in terraform
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform init -backend-config=${{ env.STATE_CONFIG_PATH }} -upgrade

      - name: Terraform Plan
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform plan -lock=false -out=tfplan -var-file=${{ env.TFVARS_PATH }} ${{ inputs.tf-plan-extra-args }}

  terraform-apply:
    name: TERRAFORM APPLY
    runs-on: ubuntu-latest
    needs: terraform-plan
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean Terraform State
        run: rm -rf .terraform

      - name: Validate terraform extra args
        if: ${{ inputs.tf-plan-extra-args }}
        run: | 
          echo "Validating terraform extra args: ${{ inputs.tf-plan-extra-args }}"
